<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>CMS Admin</title>

  <!-- 1. Cargar browser-image-compression (UMD) -->
  <script
    src="https://cdn.jsdelivr.net/npm/browser-image-compression@2.0.2/dist/browser-image-compression.min.js"
    crossorigin="anonymous">
  </script>

  <!-- 2. Validaci√≥n y compresi√≥n de im√°genes -->
  <script>
    const MAX_UPLOAD   = 5 * 1024 * 1024; // 5 MB m√°ximo
    const MIN_COMPRESS = 2 * 1024 * 1024; // 2 MB m√≠nimo para comprimir

    function formatBytes(bytes, decimals = 2) {
      if (!bytes) return '0 Bytes';
      const k = 1024;
      const sizes = ['Bytes', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return `${(bytes / Math.pow(k, i)).toFixed(decimals)} ${sizes[i]}`;
    }

    document.addEventListener('change', e => {
      const tgt = e.target;
      if (tgt.tagName !== 'INPUT' || tgt.type !== 'file') return;

      const file = tgt.files[0];
      if (!file) return;

      if (file.size > MAX_UPLOAD) {
        alert('Archivo demasiado grande (> 5 MB). Selecciona otro.');
        tgt.value = '';
        e.stopImmediatePropagation();
        e.preventDefault();
        return;
      }

      if (file.size <= MIN_COMPRESS) return;

      e.stopImmediatePropagation();
      e.preventDefault();

      const originalSize = file.size;
      const targetMB     = (originalSize / 1024 / 1024) * 0.5;

      alert(`Imagen grande (${formatBytes(originalSize)}). Se comprimir√° al ~50 % ‚âà ${targetMB.toFixed(2)} MB`);

      window.imageCompression(file, {
        maxSizeMB: targetMB,
        initialQuality: 0.9,
        useWebWorker: true,
        maxWidthOrHeight: 1920
      })
      .then(compressedBlob => {
        console.log(`Comprimida ‚Üí Antes: ${formatBytes(originalSize)}, Despu√©s: ${formatBytes(compressedBlob.size)}`);

        const newFile = new File([compressedBlob], file.name, { type: file.type });
        const dt = new DataTransfer();
        dt.items.add(newFile);
        tgt.files = dt.files;

        const evt = new Event('change', { bubbles: true });
        tgt.dispatchEvent(evt);
      })
      .catch(err => {
        console.error('Error al comprimir:', err);
        alert('No se pudo comprimir la imagen. Selecciona otro archivo.');
        tgt.value = '';
      });
    }, true);
  </script>
</head>

<body>
  <!-- 3. Bot√≥n secreto y temporizador -->
  <div id="admin-controls" style="display: none; margin-top: 20px;">
    <button id="start-demo-btn" style="padding: 10px; background: #222; color: #fff; border: none; border-radius: 5px;">
      üîê Iniciar demo (15 min)
    </button>
  </div>

  <p id="demo-timer" style="font-weight: bold; color: #fff; margin-top: 10px;">Tiempo restante: --</p>

  <!-- 4. Carga de Sveltia CMS -->
  <script src="sveltia-cms.js"></script>

  <!-- 5. Temporizador con persistencia y bot√≥n secreto -->
  <script>
    const params = new URLSearchParams(window.location.search);
    const isAdmin = params.get("admin") === "true";

    if (isAdmin) {
      document.getElementById("admin-controls").style.display = "block";
    }

    let sessionStart = parseInt(localStorage.getItem("demoSessionStart")) || null;
    let intervalId;

    function startTimer() {
      sessionStart = Date.now();
      localStorage.setItem("demoSessionStart", sessionStart);
      runTimer();
      alert("‚è±Ô∏è Temporizador iniciado. El token expira en 15 minutos.");
    }

    function runTimer() {
      clearInterval(intervalId);
      intervalId = setInterval(() => {
        if (!sessionStart) return;

        const sessionDuration = 15 * 60 * 1000;
        const sessionEnd = sessionStart + sessionDuration;
        const now = Date.now();
        const remaining = sessionEnd - now;

        const timerEl = document.getElementById("demo-timer");
        if (!timerEl) return;

        if (remaining <= 0) {
          timerEl.textContent = "‚è≥ Tu sesi√≥n ha expirado.";
          clearInterval(intervalId);
          return;
        }

        const minutes = Math.floor(remaining / 1000 / 60);
        const seconds = Math.floor((remaining / 1000) % 60);
        timerEl.textContent = `‚è±Ô∏è Tiempo restante: ${minutes}m ${seconds}s`;
      }, 1000);
    }

    document.getElementById("start-demo-btn").addEventListener("click", startTimer);

    if (sessionStart) runTimer();
  </script>
</body>
</html>
